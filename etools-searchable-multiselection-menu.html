<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../paper-input/paper-input-error.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="deletable-option-list.html">
<!--
`etools-searchable-multiselection-menu`

Dropdown menu with search and multiple options selection

### Usage
Check demo page or readme file.

### Style

Use this css variables and mixins to style this element.

Custom property | Description | Default
----------------|-------------|----------
`--esmm-option-list-color` | Multiple selected options color | `#212121`
`--esmm-list-item-selected-color` | Selected options bg color | `#DCDCDC`
`--esmm-external-wrapper` | Mixin applied to element wrapper | `{}`

@demo demo/index.html
-->

<dom-module id="etools-searchable-multiselection-menu">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
        width: 100%;
      }

      *[hidden] {
        display: none;
      }

      .external-wrapper {
        width: calc(100% - 24px);
        margin-right: 12px;
        margin-left: 12px;
        position: relative;
        @apply(--esmm-external-wrapper);
      }

      .search-input {
        background-color: #fff;
        position: absolute;
        top: 0;
        left: 0;
        width: calc(100% - 32px);
        margin: 16px;
      }

      .search-input iron-icon {
        width: 24px;
        height: 24px;
        font-size: 24px;
      }

      .value-container {
        position: relative;
      }

      .dropdown-opened .value-container,
      .dropdown-opened .multi-container {
        visibility: hidden;
      }


      #dropdownMenu {
        position: absolute;
        right: 0;
        bottom: 0;
        padding: 0;
      }

      .dropdown-trigger {
        margin-right: -8px;
        opacity: 0.54;
      }

      .input-wrapper {
        position: relative;
        z-index: 10;
        background: #fff;
        width: 100%;
        height: 45px;
        margin-right: 16px;
      }

      .multi-container {
        position: relative;
        height: 100%;
        --paper-input-container: {
          height: 45px;
          position: relative;
          width: 100%;
        }
      }

      .list-wrapper {
        position: relative;
        z-index: 5;
        max-height: 50vh;
        min-width: 150px;
        width: 100%;
        overflow-y: auto;
        padding-top: 12px;
        background: #fff;
      }

      .list-wrapper paper-listbox {
        --paper-listbox-background-color: #fff;
        --paper-listbox: {
          margin: 0;
          padding: 8px 0 0 0;
        };
      }

      .list-wrapper paper-item {
        --paper-item: {
          padding: 0 24px 0 24px;
          cursor: pointer;
        }
      }
      .tick-icon {
        display: none;
        padding-right: 8px;
      }

      .iron-selected .tick-icon {
        display: block;
      }

      .iron-selected {
        background: var(--esmm-list-item-selected-color, #DCDCDC);
      }
      .warning {
        font-family: Roboto;
        font-size: 12px;
        line-height: 16px;
        color: rgba(0,0,0,0.54);
        background-color: #EEEEEE;
      }
      .emptyValue {
        --paper-item: {
          color: rgba(0,0,0,0.38);
          padding: 0 24px 0 24px;
          cursor: pointer;
        };
      }

    </style>

    <div id="main" class$="external-wrapper [[openedClass]]">

      <template is="dom-if" if="{{!multi}}">
        <paper-input
          id="singleSelectionDropdown"
          class="value-container"
          on-tap="_openMenu"
          label="[[label]]"
          value="[[value.label]]"
          disabled="[[disabled]]"
          error-message="[[errorMessage]]"
          required$="[[_simpleRequired(required)]]"
          placeholder="[[placeholder]]"
          auto-validate$="[[autoValidate]]"
          invalid$="[[invalid]]">
        </paper-input>
      </template>

      <template is="dom-if" if="{{multi}}">

        <div class="multi-container">

          <paper-input-container
            id="customPaperInput"
            on-tap="_openMenu"
            attr-for-value="option-value"
            disabled$="[[disabled]]"
            error-message="[[errorMessage]]"
            required$="[[_multiRequired(required)]]"
            invalid$="[[invalid]]"
            always-float-label>

            <label>[[label]]</label>

            <deletable-option-list on-option-delete="_removeItem"
              class="paper-input-input"
              option-value="{{value}}"
              disabled="[[disabled]]"
              placeholder=[[placeholder]]>
            </deletable-option-list>

            <template is="dom-if" if="[[errorMessage]]">
              <paper-input-error aria-live="assertive">[[errorMessage]]</paper-input-error>
            </template>
          </paper-input-container>
        </div>
      </template>

      <paper-menu-button
        horizontal-align="right"
        id="dropdownMenu"
        ignore-select
        opened="{{menuOpened}}"
        restore-focus-on-close$="{{falseValue}}"
        on-paper-dropdown-close="_valueSelected"
        on-paper-dropdown-open="_onDropdownOpen"
        allow-outside-scroll
        dynamic-align$="[[dynamicAlign]]"
        disabled="[[disabled]]">

        <paper-icon-button icon="arrow-drop-down" class="dropdown-trigger "></paper-icon-button>

        <div class="dropdown-content">

          <div class="input-wrapper" hidden$="{{hideSearch}}">
            <paper-input
            no-label-float
            class="search-input"
            label="Search"
            type="text"
            value="{{search}}">
              <iron-icon icon="search" prefix></iron-icon>
            </paper-input>
          </div>

          <div class="list-wrapper">
            <paper-listbox
              multi="[[multi]]"
              attr-for-selected="internal-id"
              selected="{{selectedValues}}"
              selected-values="{{selectedValues}}">

              <template is="dom-repeat" items="[[shownItems]]">

                <paper-item internal-id$="{{item.value}}" on-tap="_elementSelected" class$="[[item.style]]">
                  <iron-icon class="tick-icon" icon="check"></iron-icon>
                  {{item.label}}
                </paper-item>

              </template>

               <paper-item hidden$="[[!showLimitWarning]]" class="warning">
                  More than [[shownItemsLimit]] items, use the search function to reveal more
                </paper-item>

            </paper-listbox>
          </div>

        </div>
      </paper-menu-button>
    </div>
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({

        is: 'etools-searchable-multiselection-menu',

        properties: {

          errorMessage: String,
          required: Boolean,
          placeholder: String,
          autoValidate: Boolean,
          invalid: Boolean,
          options: {
            type: Array
          },
          shownItems: {
            type: Array,
            computed: '_computeShowItems(options, search, emptyValue)'
          },
          shownItemsLimit: {
            type: Number,
            value: 50
          },
          showLimitWarning: {
            type: Boolean,
            computed: '_computeShowLimitWarning(shownItemsLimit, shownItems)'
          },
          emptyValue: {
            type: Boolean,
            value: false
          },
          search: {
            type: String
          },
          label: {
            type: String
          },
          hideSearch: {
            type: Boolean,
            value: false
          },
          value: {
            type: String,
            notify: true,
            observer: '_valueChanged'
          },
          multi: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          selectedValues: {
            notify: true
          },
          menuOpened: {
            type: Boolean,
            value: false,
            notify: true
          },
          falseValue: {
            type: Boolean,
            value: function() {
              return false;
            }
          },
          disabled: {
            type: Boolean,
            value: false
          },
          dynamicAlign: {
            type: Boolean,
            value: false
          }
        },
        ready: function() {
          if (this.autoValidate === true && this.multi === true) {
            // autoValidate for multi selection will not work, we will use a new flag in this case
            this.set('autoValidate', false);
            this.set('_autoValidateMultiSelection', true);
          }
        },
        _computeShowItems: function(options, searchKey, emptyValue) {
          var filtered = JSON.parse(JSON.stringify(options));
          if (searchKey && searchKey.length > 0) {
            filtered = options.filter(function(item) {
              return item.label && item.label.toLowerCase().indexOf(searchKey.toLowerCase()) > -1;
            });
            filtered = filtered.slice(0, Math.min(this.shownItemsLimit, filtered.length));
          } else if (options.length > this.shownItemsLimit) {
            filtered = options.slice(0, Math.min(this.shownItemsLimit, options.length));
          }

          if (emptyValue) {
            filtered.unshift({value: null, label: '-- None --', style: 'emptyValue'});
          }
          return filtered;
        },
        _computeShowLimitWarning: function(limit, shownItems) {
          return shownItems.length >= limit;
        },

        _simpleRequired: function(required) {
          return !this.multi && required;
        },

        _multiRequired: function(required) {
          return this.multi && required;
        },

        _elementSelected: function(e, detail) {
          if(!this.multi) {
            this.selectedValues = e.model.item.value;
            this._valueSelected();
            this.$.dropdownMenu.close();
          }
        },
        _valueChanged: function(value) {
          if (this.multi && value && value.length > 0 ) {
            this.set('selectedValues', value.map(function(item) {
              return '' + item.value;
            }));
          } else if (!this.multi && Array.isArray(value) && value.length > 0) {
            /**
             * In case the single selection dropdown is initialized with an array of one object
             * value and selectedValues must be updated with that object data
             */
            this.set('value', value[0]);
            this.set('selectedValues', [value[0].value]);
          } else if (!value) {
            this.set('selectedValues', null);
          }
        },
        _valueSelected: function() {
          var self = this;
          if(this.selectedValues === null) {
            this.set('value', null);
            this._fireValueChangeEvent();
          }
          if (this.selectedValues instanceof Array) {
            var newValue = [];
            this.selectedValues.forEach(function(selected) {
              self.options.forEach(function(option) {
                if (parseInt(option.value, 10) === parseInt(selected, 10)) {
                  newValue.push(option);
                }
              });
            });
            this._autoValidateMulti();
            self.set('value', newValue);
            self._fireValueChangeEvent();
          } else {
            this.options.forEach(function(item) {
              if (item.value === parseInt(self.selectedValues, 10)) {
                self.set('value', item);
                self._fireValueChangeEvent();
              }
            });
          }
          this.openedClass = '';
        },

        _removeItem: function(event, details) {
          var newSelected = [];
          if (this.selectedValues) {
            newSelected = this.selectedValues.filter(function(item) {
              return parseInt(item, 10) !== parseInt(details.value, 10);
            });
          }
          this._autoValidateMulti();
          this.set('selectedValues', newSelected);
          this._fireValueChangeEvent();
        },

        _openMenu: function() {
          if (this.value && this.value instanceof Array && this.value.length > 0) {
            return;
          }
          this.set('menuOpened', true);
        },

        _onDropdownOpen: function() {
          this.openedClass = 'dropdown-opened';
          var dropDown = this.$.dropdownMenu;
          dropDown.$.dropdown.style.width = this.$.main.offsetWidth + 'px';
          var style = dropDown.$.dropdown.querySelector('.dropdown-content').style;
          style.overflow = 'hidden';
          style.marginTop = '-20px';
        },

        _fireValueChangeEvent: function() {
          this.debounce('fireValueChanged', function () {
            var selectedValues = null;
            if ((typeof this.value === 'object' && this.value !== null) ||
              (this.value instanceof Array && this.value.length > 0)) {
              selectedValues = this.value;
            }
            this.fire('value-change', {selectedValues: selectedValues});
          }.bind(this), 100);
        },

        _autoValidateMulti: function() {
          if (this._autoValidateMultiSelection) {
            this.validate();
          }
        },

        validate: function() {
          if (!this.multi) {
            // single selection validation
            return this.$$('#singleSelectionDropdown').validate();
          } else {
            // multiple selection validation
            var valid = false;
            if (this._multiRequired(this.required)) {
              if (Array.isArray(this.selectedValues) && this.selectedValues.length > 0) {
                valid = true;
              }
            } else {
              valid = true; // is not required
            }

            this.set('invalid', !valid);
            return valid;
          }
        }
      });
    })();
  </script>
</dom-module>
