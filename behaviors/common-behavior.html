<script>
window.etoolsSearchableDropdown = window.etoolsSearchableDropdown || {};
/** @polymerBehavior etoolsSearchableDropdown.CommonBehavior */
etoolsSearchableDropdown.CommonBehavior = { // eslint-disable-line no-undef
  properties: {
     label: {
          type: String
     },
     required: {
       type: Boolean
     },
     search: {
       type: String
     },
      options: {
        type: Array
      },
      shownOptions: {
        type: Array,
        computed: '_computeShownOptions(options, search, showEmptyValue, options.length)'
      },
      optionValue: {
        type: String,
        value: 'value'
      },
      optionLabel: {
        type: String,
        value: 'label'
      },
      dynamicAlign: {
        type: Boolean,
        value: true
      },
      allowOutsideScroll: {
        type:Boolean
      },
      showEmptyValue: {
        type: Boolean,
        value: false
      },
      hideSearch: {
        type: Boolean,
        value: false
      },
      disabled: {
        type: Boolean,
        value: false
      },
      readonly: {
        type: Boolean,
        value: function() {
          return false;
        },
        reflectToAttribute: true,
        observer: '_readonlyChanged'
      },
      invalid: {
        type: Boolean,
        value: function() {
          return false;
        },
        reflectToAttribute: true
      },
      errorMessage: {
        type: String
      },
      shownItemsLimit: {
        type: Number,
        value: 50
      },
      noOptionsAvailable: {
        type: Boolean,
        value: true,
        computed: '_computeNoOptionsAvailable(options, options.length)'
      },
      showLimitWarning: {
         type: Boolean,
         value: false,
         computed: '_computeShowLimitWarning(shownItemsLimit, shownOptions)'
      },
      showNoSearchResultsWarning: {
        type: Boolean,
        value: false,
        computed: '_showNoSearchResultsWarning(noOptionsAvailable, shownOptions.length, options.length)'
      },
       autoValidate: {
         type: Boolean
       },
       placeholder: {
         type: String,
         value: 'â€”'
       },
       restoreFocusOnClose: {
          type: Boolean,
          value: function() {
            return false;
          }
        },
    },
    _noOptions: function() {
        return (!this.options || !this.options.length);
    },
    _menuBtnIsDisabled: function(disabled, readonly) {
      return disabled || readonly;
    },

    //*Use of this method covers a corner case
    _getSelectedClass: function(item, selected) {
      return selected === item[this.optionValue] ? 'iron-selected' : '';
    },
    _getValue: function(item) {
        return item ? item[this.optionValue] : null;
      },
    _getLabel: function(item) {
        return (item && item[this.optionLabel]) ? item[this.optionLabel] : null;
      },
    resetInvalidState: function() {
      this.set('invalid', false);
    },
    _computeNoOptionsAvailable: function(options, optionsLength) {
       return !Array.isArray(options) || !optionsLength;
    },
    _readonlyChanged: function(readonly, oldReadonly) {
       if (typeof oldReadonly !== 'undefined' && readonly !== oldReadonly) {
         this.updateStyles();
       }
    },
    _computeShownOptions: function(options, search, showEmptyValue) {
      var shownOptions = JSON.parse(JSON.stringify(options));

      if (search) {
        shownOptions = options.filter(this._itemContainsSearchString.bind(this));
        shownOptions = this._trimByShownItemsLimit(shownOptions);
      } else if (options.length > this.shownItemsLimit) {
        shownOptions = this._trimByShownItemsLimit(options);
      }

      if (showEmptyValue) {
        var emptyOption = {cssClass: 'emptyValue'};
        emptyOption[this.optionValue] = null;
        emptyOption[this.optionLabel] = '-- None --';
        shownOptions.unshift(emptyOption);
      }
      return shownOptions;
      },
      _trimByShownItemsLimit: function(options) {
        return options.slice(0, Math.min(this.shownItemsLimit, options.length));
      },
      _itemContainsSearchString: function(item) {
        return item[this.optionLabel] && item[this.optionLabel].toLowerCase().indexOf(this.search.toLowerCase()) > -1;
      },
      _computeShowLimitWarning: function(limit, shownOptions) {
        return  shownOptions.length >= limit;
      },
      _showNoSearchResultsWarning: function(noOptionsAvailable, shownOptionsLength, optionsLength) {
       if (noOptionsAvailable) {
         return false;
       }
        return (optionsLength > 0 && shownOptionsLength === 0) ||
            (shownOptionsLength === 1 && this.shownOptions[0][this.optionValue] === null);

      },
      _onDropdownOpen: function() {
        var ironDropdown = this._getIronDropdown();
        if (ironDropdown) {
          // set position target to align dropdown content properly
          ironDropdown.set('positionTarget', this);
          ironDropdown.style.width = this.offsetWidth + 'px';
          var style = ironDropdown.querySelector('.dropdown-content').style;
          style.overflow = 'hidden';
        }
      },
      _getIronDropdown: function() {
        return this.$.dropdownMenu.$.dropdown;
      }
};
</script>
