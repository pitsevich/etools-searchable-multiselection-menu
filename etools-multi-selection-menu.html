<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-input/paper-input-error.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-input/paper-input-container.html">

<link rel="import" href="../etools-ajax/etools-ajax.html">
<link rel="import" href="behaviors/missing-options-behavior.html">
<link rel="import" href="behaviors/common-behavior.html">
<link rel="import" href="styles/etools-dropdown-shared-styles.html">
<link rel="import" href="scripts/es6-polyfills.html">
<!--
`etools-multi-selection-menu`
Dropdown with search and multi selection capabilities

@demo demo/index.html
-->
<dom-module id="etools-multi-selection-menu">
  <template>
    <style include="etools-dropdown-shared-styles">
       :host {
        display: block;
        position: relative;
        width: 100%;
      }

      .content-wrapper {
        max-width: calc(100% - 24px);
      }
      /*.readonly-separator,*/

      .option-string {
        display: inline-block;
        width: auto;
        height: auto;
        margin-right: 8px;
        font-size: 16px;
        line-height: 24px;
        color: var(--esmm-option-list-color, #212121);
      }

       :host([readonly]) .option-string {
        margin-right: 0;
      }

       :host([readonly]) .option-string paper-icon-button,
       :host([readonly]) .option-string:last-of-type .readonly-separator {
        display: none;
      }

      .readonly-separator {
        display: inline-block;
        padding: 0 5px;
        margin: 0;
      }

      .option-string paper-icon-button {
        color: var(--esmm-delete-icon-color, #dd2c00);
        padding: 0;
        height: 18px;
        width: 18px;
      }
    </style>

    <etools-ajax id="missingOptionsAjax" params="[[ajaxParams]]" on-success="_handleMissingOptionsReqResponse" on-fail="_handleMissingOptionsReqError"></etools-ajax>

    <paper-input-container id="main"
    class="external-wrapper"
     always-float-label
      disabled$="[[disabled]]"
      invalid$="[[invalid]]"
      auto-validate="[[autoValidate]]"
      required$="[[required]]"
      attr-for-value="selected-values">

      <label aria-hidden="true" for="main-input">[[label]]</label>
      <input type="text"  class="paper-input-input"  hidden>

      <div class="content-wrapper">
        <template is="dom-repeat" items="[[selectedItems]]">
          <span class="option-string">
          {{_getLabel(item)}}
          <span class="readonly-separator" hidden$=[[!readonly]]>|</span>
          <paper-icon-button hidden$="[[disabled]]" icon="close" on-click="_removeSelectedItem"></paper-icon-button>
          </span>
        </template>
      </div>
      <template is="dom-if" if="[[invalid]]">
        <paper-input-error aria-live="assertive">[[errorMessage]]</paper-input-error>
      </template>


      <paper-menu-button id="dropdownMenu" horizontal-align="right" ignore-select
        restore-focus-on-close$="[[restoreFocusOnClose]]"
        allow-outside-scroll="[[allowOutsideScroll]]" dynamic-align$="[[dynamicAlign]]" on-paper-dropdown-open="_onDropdownOpen"
        disabled$="[[_menuBtnIsDisabled(disabled, readonly)]]" hidden$="[[readonly]]">

        <iron-icon icon="arrow-drop-down" class="dropdown-trigger"></iron-icon>

        <div class="dropdown-content">
          <div class="search-input-wrapper" hidden$="{{hideSearch}}">
            <paper-input id="searchInput" no-label-float class="search-input" label="Search" type="text" value="{{search}}" auto-focus
              tabindex="0">
              <iron-icon icon="search" prefix></iron-icon>
            </paper-input>
          </div>
          <div class="list-wrapper">
            <paper-listbox multi attr-for-selected="internal-id"
                           selected-values={{selectedValues}}
                           on-selected-values-changed="_onSelectedValuesChanged">
              <template is="dom-repeat" items="[[shownOptions]]">
                <paper-item item=[[item]] internal-id$="[[_getValue(item)]]" class$="[[item.cssClass]][[_getSelectedClass(item, selected)]]"
                  title$="[[_getLabel(item)]]">

                  <iron-icon class="tick-icon" icon="check"></iron-icon>
                  <span>[[_getLabel(item)]]</span>
                </paper-item>
              </template>

              <paper-item hidden$="[[!_showNoSearchResultsWarning(shownOptions.length, options.length)]]" class="warning" disabled>
                No results found. Try other keywords.
              </paper-item>

              <paper-item hidden$="[[!showLimitWarning]]" class="warning" disabled>
                More than [[shownOptionsLimit]] items, use the search function to reveal more.
              </paper-item>

              <paper-item hidden$="[[!noOptionsAvailable]]" class="warning" disabled>
                No options available.
              </paper-item>
            </paper-listbox>
          </div>
        </div>
      </paper-menu-button>

    </paper-input-container>
  </template>

  <script>
    Polymer({
      is: 'etools-multi-selection-menu',
      behaviors: [
        etoolsSearchableDropdown.MissingOptionsBehavior,
        etoolsSearchableDropdown.CommonBehavior
      ],
      properties: {
        selectedValues: {
          type: Array,
          notify: true
        },
        selectedItems: {
          type: Array,
          notify: true
        },
        notFoundOptions: {
          type: Array,
        },
        optionValueType: {
          type: String,
          value: 'string'
        }

      },
      observers: [
        '_selectedValuesOrOptionsChanged(selectedValues, options)'
      ],
      _selectedValuesSplices: function(e) {
        console.log('_selectedValuesSplices',e);
        this._preserveOptionValueType();
        console.log('SELVALUES', this.selectedValues);
        //this._setSelectedItems();
      },

      // selectedValues Change doesn't fire when you select and deselect items from the dropdown, on account of unobservable array mutations
      // but it fires when you enter the page and have preselected values
      _selectedValuesOrOptionsChanged: function(selectedValues, options, b) {

        console.log('_selectedValuesOrOptionsChanged', selectedValues);
        this._preserveOptionValueType(selectedValues);
        this._setSelectedItems(selectedValues);
      },

      _preserveOptionValueType: function(selectedValues) {
        if (this._noOptions()) {
          return;
        }
        selectedValues = selectedValues || this.selectedValues;
      //  console.log('_preserveOptionValueType', selectedValues);
        if (!selectedValues || !selectedValues.length) {
          return;
        }
        var type = typeof this.options[0][this.optionValue];

        selectedValues.forEach(function(value, index){
          if (typeof value !== type) {
            selectedValues[index] = parseInt(value, 10);
          }
        });
      },
      // Can't use paper-listbox's on-selected-items-changed event ,
      // because paper-lisbox doesn't cover the case when selectedItems are not in the shownOptions values
      _setSelectedItems: function(selectedValues) {
        selectedValues = selectedValues || this.selectedValues;
        if (!selectedValues || !selectedValues.length || this._noOptions()) {
          this.selectedItems = null;
          return;
        }
        if (this.selectedItems && this.selectedItems.length === this.selectedValues.length) {
          return;
        }
        var selectedItems = this.options.filter(function(item) {
          return selectedValues.includes(item[this.optionValue]);
        }.bind(this));
        this.selectedItems = selectedItems;
      },
      // The alternative of an observer on selectedValues.splices doesn't work as it sees a deselect as a select
      // The alternative of using on-selected-items-changed doesn't work when the selectedValues is not in the 50 shownOptions
      _onSelectedValuesChanged: function(event) {
        console.log('SELVALUES2', this.selectedValues);
        var possiblePaths = ['selectedValues.splices','selectedValues.length'];

        if (possiblePaths.includes(event.detail.path)) {
          if (event.detail.path === possiblePaths[0]) {
            var selValuesInfo = event.detail.value.indexSplices[0];
            if (selValuesInfo.addedCount) {

            } else {
              if (selValuesInfo.removed) {

              }
            }
          }
        } else {

        }

        if (event.detail.path == "selectedValues.splices") {
          console.log("selectedValues.splices",event.detail.value.indexSplices[0]);
        }
        else {
          console.log('_onSelectedValuesChanged',event.detail);
        }
      },

      _removeSelectedItem: function(e) {
        if (this.disabled) {
          return;
        }
        // Compute selectedItems without the removed item
        var selItems = this.selectedItems.filter(function(item) {
            return item[this.optionValue] !== e.model.item[this.optionValue];
        }.bind(this));

        if (!selItems || !selItems.length) {
          this._emptySelected_WithoutObservableChanges();
          return;
        }

        selValues = this._getValuesFromItems(selItems);
        this._updateSelected_WithoutObservableChanges(selValues, selItems);
      },
      _getValuesFromItems: function(selectedItems) {
       return (selectedItems && selectedItems.length > 0) ? selectedItems.map(function(item){
         return item[this.optionValue];
       }.bind(this)) : null;
      },
      _emptySelected_WithoutObservableChanges: function() {
         this.selectedItems.splice(0, this.selectedItems.length);
         this.selectedValues.splice(0, this.selectedValues.length);
      },
      _updateSelected_WithoutObservableChanges: function(selectedValues, selectedItems) {
       // Array.prototype.splice.apply(this.selectedValues)
        this.selectedValues.splice(0, selectedValues);
        this.selectedItems.splice(0, this.selectedItems.length, selectedItems);
      }

    });
  </script>
</dom-module>
